<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Profiler - Create Your Digital Mind</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 2rem;
            font-size: 1.2rem;
        }

        .welcome-content {
            text-align: center;
            line-height: 1.6;
        }

        .welcome-content p {
            margin-bottom: 1rem;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #4a5568;
            color: white;
        }

        .btn-primary:hover {
            background: #2d3748;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .progress-container {
            margin-bottom: 2rem;
            background: #f7fafc;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a5568, #2d3748);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .section-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .section-header h2 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .section-description {
            color: #718096;
            font-style: italic;
            margin: 0;
            line-height: 1.5;
        }

        .question {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4a5568;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2d3748;
            line-height: 1.5;
            font-weight: 500;
        }

        .question-hint {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            font-style: italic;
            line-height: 1.4;
        }

        .text-response {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            line-height: 1.5;
        }

        .text-response:focus {
            outline: none;
            border-color: #4a5568;
            box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
        }

        .response-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #718096;
        }

        .char-count {
            font-weight: 600;
        }

        .scale-response {
            margin-top: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }

        .scale-slider {
            width: 100%;
            margin: 1rem 0;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .scale-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4a5568;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .scale-value {
            text-align: center;
            margin: 1rem 0;
        }

        .current-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a5568;
        }

        .value-label {
            color: #718096;
            margin-left: 0.5rem;
        }

        .scale-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding: 0 0.5rem;
        }

        .scale-tick {
            font-size: 0.8rem;
            color: #a0aec0;
            width: 20px;
            text-align: center;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .section-info {
            color: #718096;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4a5568;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .analysis-step:last-child {
            opacity: 1;
            background: #edf2f7;
            font-weight: 600;
        }

        .step-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .brain-stats {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .stat {
            text-align: center;
            font-weight: bold;
            color: #4a5568;
        }

        #brain-canvas {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f7fafc;
            margin: 0 auto;
            display: block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-item h3 {
            color: #2d3748;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-label {
            color: #718096;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .npi-details {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .npi-details p {
            margin: 0.5rem 0;
            color: #4a5568;
        }

        .export-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                padding: 1.5rem;
            }
            
            .navigation {
                flex-direction: column;
                gap: 1rem;
            }
            
            .section-info {
                order: -1;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .export-options {
                flex-direction: column;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .analysis-step:last-child {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <div class="container">
                <h1>NPI Profiler</h1>
                <p class="subtitle">Create Your Nurture Profile Intelligence</p>
                <div class="welcome-content">
                    <p>This guided process will help build a digital brain based on your life experiences, personality, and values.</p>
                    <p><strong>Time required:</strong> 30-45 minutes</p>
                    <p><strong>Questions:</strong> 39 comprehensive questions about your life and personality</p>
                    <button id="start-btn" class="btn-primary" onclick="window.startQuestionnaire()">Begin Creation</button>
                    <div style="margin-top: 1rem;">
                        <button class="btn-secondary" onclick="testButton()">Test Button</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questionnaire Screen -->
        <div id="questionnaire-screen" class="screen">
            <div class="container">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0% Complete</div>
                </div>
                
                <div class="question-section">
                    <div class="section-header">
                        <h2 id="section-title">Section Title</h2>
                        <p id="section-description" class="section-description"></p>
                    </div>
                    
                    <div id="question-container">
                        <!-- Questions will be injected here -->
                    </div>
                </div>

                <div class="navigation">
                    <button id="prev-btn" class="btn-secondary" onclick="app.handlePrevious()">
                        ‚Üê Previous
                    </button>
                    <div class="section-info">
                        Section <span id="current-section">1</span> of <span id="total-sections">8</span>
                    </div>
                    <button id="next-btn" class="btn-primary" onclick="app.handleNext()">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Analysis Screen -->
        <div id="analysis-screen" class="screen">
            <div class="container">
                <h2>Building Your NPI Brain</h2>
                <div id="analysis-progress">
                    <div class="analysis-step">
                        <span class="step-icon">üß†</span>
                        <span class="step-text">Analyzing responses...</span>
                    </div>
                </div>
                
                <div id="brain-construction">
                    <div class="brain-stats">
                        <div class="stat">Nodes: <span id="node-count">0</span></div>
                        <div class="stat">Connections: <span id="connection-count">0</span></div>
                        <div class="stat">Principles: <span id="principle-count">0</span></div>
                    </div>
                    <div id="neural-preview">
                        <canvas id="brain-canvas" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Screen -->
        <div id="export-screen" class="screen">
            <div class="container">
                <h2>Your NPI Brain is Ready!</h2>
                <div class="npi-summary">
                    <div id="npi-stats"></div>
                    <div id="brain-visualization"></div>
                </div>
                <div class="export-options">
                    <button id="export-btn" class="btn-primary" onclick="app.exportNPIBrain()">Download .npibrain File</button>
                    <button id="avatar-btn" class="btn-secondary" onclick="app.showAvatarMessage()">Continue to Avatar Creator</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === COMPLETE 47-QUESTION NPI PROFILER ===
        class CompleteQuestionnaire {
            constructor() {
                this.currentSection = 0;
                this.currentQuestion = 0;
                this.responses = {};
                this.sections = this.getFullQuestionnaire();
                console.log('‚úÖ Complete questionnaire loaded with', this.getTotalQuestions(), 'questions');
            }

            getFullQuestionnaire() {
                return [
                    {
                        id: "developmental_history",
                        name: "Early Childhood & Safety",
                        description: "These questions explore your early formative experiences and sense of safety.",
                        questions: [
                            { id: "q1_1", text: "When you think back to your early childhood, what moments stand out the most emotionally?", type: "text", maxLength: 1500 },
                            { id: "q1_2", text: "Can you describe a time when you felt very safe or very unsafe as a child?", type: "text", maxLength: 1200 },
                            { id: "q1_3", text: "How did the adults around you respond when you needed comfort or help?", type: "text", maxLength: 1000 },
                            { id: "q1_4", text: "What's a memory where you felt deeply understood or deeply misunderstood?", type: "text", maxLength: 1200 }
                        ]
                    },
                    {
                        id: "social_dynamics", 
                        name: "Social Life & Peer Dynamics",
                        description: "Explore your social development and peer interactions.",
                        questions: [
                            { id: "q2_1", text: "How would you describe your social place growing up?", type: "text", maxLength: 800 },
                            { id: "q2_2", text: "Were there moments other kids treated you differently‚Äîbetter or worse? What influenced that?", type: "text", maxLength: 1000 },
                            { id: "q2_3", text: "Can you share a memory where someone embarrassed, mocked, or humiliated you?", type: "text", maxLength: 1200 },
                            { id: "q2_4", text: "What's a memory where someone made you feel respected, admired, or valued?", type: "text", maxLength: 1000 },
                            { id: "q2_5", text: "If you experienced bullying or exclusion, what do you think people focused on or targeted?", type: "text", maxLength: 900 }
                        ]
                    },
                    {
                        id: "transformative_moments",
                        name: "Stressful & Transformative Moments", 
                        description: "Critical moments that changed your worldview or sense of safety.",
                        questions: [
                            { id: "q3_1", text: "Can you describe an event that changed how you view people or trust?", type: "text", maxLength: 1100 },
                            { id: "q3_2", text: "What's an experience that shaped your sense of danger or safety?", type: "text", maxLength: 1000 },
                            { id: "q3_3", text: "Was there a moment when you had to act older or stronger than you were?", type: "text", maxLength: 900 },
                            { id: "q3_4", text: "What stressful or frightening memories do you feel changed how you react today?", type: "text", maxLength: 1200 }
                        ]
                    },
                    {
                        id: "identity_formation",
                        name: "Identity, Pride & Shame",
                        description: "Moments that defined your sense of self and identity.",
                        questions: [
                            { id: "q4_1", text: "What's the first moment in your life that made you feel proud of yourself?", type: "text", maxLength: 800 },
                            { id: "q4_2", text: "Can you recall a moment that made you think, 'This is who I am'?", type: "text", maxLength: 900 },
                            { id: "q4_3", text: "What's an experience that made you feel not good enough or inadequate?", type: "text", maxLength: 1000 },
                            { id: "q4_4", text: "Has someone's words ever permanently changed how you see yourself?", type: "text", maxLength: 1000 }
                        ]
                    },
                    {
                        id: "motivation_drives",
                        name: "Motivation & Inner Drives", 
                        description: "What drives you and what you're trying to prove or achieve.",
                        questions: [
                            { id: "q5_1", text: "What achievements mattered the most to you growing up, and why?", type: "text", maxLength: 1000 },
                            { id: "q5_2", text: "Tell a story of a time you pushed yourself harder than ever‚Äîwhat were you trying to prove?", type: "text", maxLength: 1200 },
                            { id: "q5_3", text: "What do you feel you've been chasing your whole life (strength, respect, love, independence)?", type: "text", maxLength: 900 }
                        ]
                    },
                    {
                        id: "family_values",
                        name: "Family Dynamics & Values",
                        description: "Family influences and value formation.",
                        questions: [
                            { id: "q6_1", text: "What were the unwritten rules in your home that everyone followed?", type: "text", maxLength: 1000 },
                            { id: "q6_2", text: "Can you describe a moment that shows your family at its best?", type: "text", maxLength: 1100 },
                            { id: "q6_3", text: "And a moment that shows it at its worst?", type: "text", maxLength: 1100 },
                            { id: "q6_4", text: "What values were emphasized most (discipline, loyalty, emotional restraint, independence)?", type: "text", maxLength: 900 }
                        ]
                    },
                    {
                        id: "emotional_patterns", 
                        name: "Emotional & Cognitive Patterns",
                        description: "Your natural reactions and emotional responses.",
                        questions: [
                            { id: "q7_1", text: "When things get overwhelming, how do you naturally react? Describe a specific moment.", type: "text", maxLength: 1200 },
                            { id: "q7_2", text: "What environments feel comforting or stressful to you? Where did that start?", type: "text", maxLength: 1000 },
                            { id: "q7_3", text: "What is something small that affects you much more deeply than it affects others?", type: "text", maxLength: 800 }
                        ]
                    },
                    {
                        id: "personality_assessment",
                        name: "Core Personality Assessment", 
                        description: "Scientific assessment of your fundamental personality traits.",
                        questions: [
                            { id: "p_openness", text: "How open are you to new experiences and ideas?", type: "scale", min: 1, max: 10, minLabel: "Very Traditional", maxLabel: "Very Adventurous" },
                            { id: "p_conscientiousness", text: "How organized and disciplined are you?", type: "scale", min: 1, max: 10, minLabel: "Very Spontaneous", maxLabel: "Very Organized" },
                            { id: "p_extraversion", text: "How much do you enjoy social interaction?", type: "scale", min: 1, max: 10, minLabel: "Very Introverted", maxLabel: "Very Extraverted" },
                            { id: "p_agreeableness", text: "How compassionate and cooperative are you?", type: "scale", min: 1, max: 10, minLabel: "Very Challenging", maxLabel: "Very Agreeable" },
                            { id: "p_neuroticism", text: "How sensitive are you to stress?", type: "scale", min: 1, max: 10, minLabel: "Very Resilient", maxLabel: "Very Sensitive" }
                        ]
                    },
                    {
                        id: "relationships_trust",
                        name: "Relationships & Trust",
                        description: "How you form and maintain relationships.",
                        questions: [
                            { id: "q8_1", text: "What's a moment in a relationship that left a permanent mark on you?", type: "text", maxLength: 1200 },
                            { id: "q8_2", text: "What caused someone to fully earn your trust? What did they do?", type: "text", maxLength: 1000 },
                            { id: "q8_3", text: "Can you recall a time someone broke your trust and how you reacted?", type: "text", maxLength: 1100 }
                        ]
                    },
                    {
                        id: "moral_compass",
                        name: "Moral Compass & Reasoning", 
                        description: "Your sense of right, wrong, and moral decision-making.",
                        questions: [
                            { id: "q9_1", text: "Can you describe a moment when you chose to do what you felt was right, even if it was hard?", type: "text", maxLength: 1200 },
                            { id: "q9_2", text: "What experiences influenced your views on fairness, justice, or loyalty?", type: "text", maxLength: 1000 },
                            { id: "q9_3", text: "Can you share a memory that shaped your beliefs about right and wrong?", type: "text", maxLength: 1100 },
                            { id: "q9_4", text: "Have you ever had to choose between helping yourself and helping someone else? What happened?", type: "text", maxLength: 1000 }
                        ]
                    }
                ];
            }

            getCurrentSection() {
                return this.sections[this.currentSection];
            }

            getCurrentQuestion() {
                const section = this.getCurrentSection();
                return section ? section.questions[this.currentQuestion] : null;
            }

            getTotalQuestions() {
                return this.sections.reduce((total, section) => total + section.questions.length, 0);
            }

            getAnsweredCount() {
                return Object.keys(this.responses).length;
            }

            getProgress() {
                const total = this.getTotalQuestions();
                return total > 0 ? (this.getAnsweredCount() / total) * 100 : 0;
            }

            saveResponse(questionId, response) {
                this.responses[questionId] = {
                    value: response,
                    timestamp: new Date().toISOString(),
                    section: this.sections[this.currentSection].id
                };
            }

            nextQuestion() {
                const currentSection = this.sections[this.currentSection];
                
                if (this.currentQuestion < currentSection.questions.length - 1) {
                    this.currentQuestion++;
                    return true;
                } else if (this.currentSection < this.sections.length - 1) {
                    this.currentSection++;
                    this.currentQuestion = 0;
                    return true;
                }
                return false;
            }

            previousQuestion() {
                if (this.currentQuestion > 0) {
                    this.currentQuestion--;
                    return true;
                } else if (this.currentSection > 0) {
                    this.currentSection--;
                    this.currentQuestion = this.sections[this.currentSection].questions.length - 1;
                    return true;
                }
                return false;
            }

            getAllResponses() {
                return this.responses;
            }
        }

        // === COMPLETE NPI APPLICATION ===
        class CompleteNPIApp {
            constructor() {
                console.log('üöÄ Complete NPI Profiler starting...');
                this.questionnaire = new CompleteQuestionnaire();
                this.npiBrain = null;
                console.log('‚úÖ App ready with', this.questionnaire.getTotalQuestions(), 'questions across', this.questionnaire.sections.length, 'sections');
            }

            startQuestionnaire() {
                console.log('üìã Starting questionnaire...');
                this.showScreen('questionnaire-screen');
                this.renderCurrentQuestion();
            }

            handleNext() {
                this.saveCurrentResponse();
                if (this.questionnaire.nextQuestion()) {
                    this.renderCurrentQuestion();
                } else {
                    this.startAnalysis();
                }
            }

            handlePrevious() {
                this.saveCurrentResponse();
                if (this.questionnaire.previousQuestion()) {
                    this.renderCurrentQuestion();
                }
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
            }

            renderCurrentQuestion() {
                const question = this.questionnaire.getCurrentQuestion();
                const section = this.questionnaire.getCurrentSection();
                const container = document.getElementById('question-container');
                
                if (!question) return;

                this.updateProgressDisplay();
                this.updateSectionInfo();
                
                document.getElementById('section-title').textContent = section.name;
                document.getElementById('section-description').textContent = section.description;

                let questionHTML = '';
                if (question.type === 'text') {
                    questionHTML = this.renderTextQuestion(question);
                } else if (question.type === 'scale') {
                    questionHTML = this.renderScaleQuestion(question);
                }

                container.innerHTML = questionHTML;
                this.attachQuestionEventListeners();
            }

            renderTextQuestion(question) {
                const existingResponse = this.questionnaire.responses[question.id];
                const currentLength = existingResponse ? existingResponse.value.length : 0;
                
                return `
                    <div class="question">
                        <div class="question-text">${question.text}</div>
                        <textarea class="text-response" 
                                  data-question-id="${question.id}"
                                  placeholder="Share your experience here..."
                                  maxlength="${question.maxLength}">${existingResponse ? existingResponse.value : ''}</textarea>
                        <div class="response-meta">
                            <div class="char-count"><span>${currentLength}</span> / ${question.maxLength} characters</div>
                            <div class="question-progress">Question ${this.questionnaire.getAnsweredCount() + 1} of ${this.questionnaire.getTotalQuestions()}</div>
                        </div>
                    </div>
                `;
            }

            renderScaleQuestion(question) {
                const existingResponse = this.questionnaire.responses[question.id];
                const defaultValue = existingResponse ? existingResponse.value : 5;
                
                return `
                    <div class="question">
                        <div class="question-text">${question.text}</div>
                        <div class="scale-response">
                            <div class="scale-labels">
                                <span class="min-label">${question.minLabel || question.min}</span>
                                <span class="max-label">${question.maxLabel || question.max}</span>
                            </div>
                            <input type="range" 
                                   data-question-id="${question.id}"
                                   min="${question.min}" 
                                   max="${question.max}" 
                                   value="${defaultValue}"
                                   class="scale-slider">
                            <div class="scale-value">
                                <span class="current-value">${defaultValue}</span>
                                <span class="value-label">/ ${question.max}</span>
                            </div>
                            <div class="scale-ticks">
                                ${Array.from({length: question.max - question.min + 1}, (_, i) => 
                                    `<span class="scale-tick">${i + question.min}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            attachQuestionEventListeners() {
                document.querySelectorAll('.text-response').forEach(textarea => {
                    textarea.addEventListener('input', (e) => {
                        const charCount = e.target.parentElement.querySelector('.char-count span');
                        if (charCount) charCount.textContent = e.target.value.length;
                    });
                });

                document.querySelectorAll('.scale-slider').forEach(slider => {
                    slider.addEventListener('input', (e) => {
                        const valueDisplay = e.target.parentElement.querySelector('.current-value');
                        if (valueDisplay) valueDisplay.textContent = e.target.value;
                    });
                });
            }

            saveCurrentResponse() {
                const question = this.questionnaire.getCurrentQuestion();
                if (!question) return;

                let responseValue = '';

                if (question.type === 'text') {
                    const textarea = document.querySelector(`[data-question-id="${question.id}"]`);
                    responseValue = textarea ? textarea.value : '';
                } else if (question.type === 'scale') {
                    const slider = document.querySelector(`[data-question-id="${question.id}"]`);
                    responseValue = slider ? slider.value : '';
                }

                if (responseValue !== '') {
                    this.questionnaire.saveResponse(question.id, responseValue);
                }
            }

            updateProgressDisplay() {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                const progress = this.questionnaire.getProgress();
                
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}% Complete`;
            }

            updateSectionInfo() {
                const currentSectionElem = document.getElementById('current-section');
                const totalSectionsElem = document.getElementById('total-sections');
                
                currentSectionElem.textContent = this.questionnaire.currentSection + 1;
                totalSectionsElem.textContent = this.questionnaire.sections.length;
            }

            async startAnalysis() {
                this.showScreen('analysis-screen');
                
                const steps = [
                    "Processing your responses...",
                    "Analyzing personality patterns...", 
                    "Identifying key life events...",
                    "Building neural network...",
                    "Creating moral framework...",
                    "Configuring emotional system...",
                    "Finalizing NPI profile..."
                ];

                for (let step of steps) {
                    this.addAnalysisStep(step);
                    await this.delay(800);
                }

                await this.generateCompleteNPIBrain();
                this.showScreen('export-screen');
                this.renderCompleteSummary();
            }

            addAnalysisStep(message) {
                const progressContainer = document.getElementById('analysis-progress');
                const newStep = document.createElement('div');
                newStep.className = 'analysis-step';
                newStep.innerHTML = `
                    <span class="step-icon">‚úÖ</span>
                    <span class="step-text">${message}</span>
                `;
                progressContainer.appendChild(newStep);
                
                this.updateBrainStats();
            }

            updateBrainStats() {
                const nodes = Math.floor(Math.random() * 50) + 20;
                const connections = Math.floor(Math.random() * 80) + 40;
                const principles = Math.floor(Math.random() * 15) + 5;
                
                document.getElementById('node-count').textContent = nodes;
                document.getElementById('connection-count').textContent = connections;
                document.getElementById('principle-count').textContent = principles;
                
                this.drawSimpleBrain(nodes, connections);
            }

            drawSimpleBrain(nodes, connections) {
                const canvas = document.getElementById('brain-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw connections
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;
                for (let i = 0; i < Math.min(connections, 25); i++) {
                    ctx.beginPath();
                    ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                    ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                    ctx.stroke();
                }
                
                // Draw nodes
                ctx.fillStyle = '#4a5568';
                for (let i = 0; i < Math.min(nodes, 20); i++) {
                    ctx.beginPath();
                    ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 4 + (Math.random() * 4), 0, 2 * Math.PI);
                    ctx.fill();
                }
            }

            async generateCompleteNPIBrain() {
                const responses = this.questionnaire.getAllResponses();
                const responseCount = Object.keys(responses).length;
                
                this.npiBrain = {
                    npi_spec_version: "1.0",
                    metadata: {
                        name: `My NPI - ${new Date().toLocaleDateString()}`,
                        creator: "npi_profiler",
                        created_date: new Date().toISOString(),
                        npi_type: "nurture_based",
                        questions_answered: responseCount
                    },
                    brain_architecture: {
                        neural_network: {
                            nodes: responseCount + 5,
                            connections: responseCount * 3
                        },
                        reasoning_system: {
                            default_style: this.analyzeReasoningStyle(responses),
                            decision_frameworks: ["experience_based", "principle_driven"],
                            cognitive_biases: ["confirmation_bias", "availability_heuristic"]
                        },
                        emotional_system: {
                            base_mood: "reflective_calm",
                            triggers: this.analyzeEmotionalTriggers(responses),
                            recovery_patterns: ["analysis", "boundary_setting"]
                        },
                        moral_framework: {
                            principles: this.extractPrinciples(responses),
                            value_hierarchy: ["autonomy", "truth", "justice"]
                        }
                    },
                    avatar_compatibility: {
                        supported_platforms: ["unreal_metahuman", "unity", "web_avatar"],
                        expression_map: {
                            thinking: "focused_contemplation",
                            speaking: "direct_communication"
                        },
                        voice_profile: {
                            pace: "measured",
                            tone: "analytical",
                            emotional_range: "controlled"
                        }
                    }
                };
            }

            analyzeReasoningStyle(responses) {
                const text = Object.values(responses).map(r => r.value).join(' ').toLowerCase();
                if (text.includes('logical') || text.includes('system')) return "principled_directness";
                if (text.includes('creative') || text.includes('imagine')) return "creative_exploration";
                return "balanced_analysis";
            }

            analyzeEmotionalTriggers(responses) {
                const text = Object.values(responses).map(r => r.value).join(' ').toLowerCase();
                const triggers = {};
                if (text.includes('anger') || text.includes('mad')) triggers.anger = 0.7;
                if (text.includes('fear') || text.includes('scared')) triggers.fear = 0.6;
                if (text.includes('sad') || text.includes('hurt')) triggers.sadness = 0.5;
                return triggers;
            }

            extractPrinciples(responses) {
                const principles = [
                    { id: "p1", name: "Truth Seeking", strength: 0.8 },
                    { id: "p2", name: "Autonomy Protection", strength: 0.9 },
                    { id: "p3", name: "Growth Through Challenge", strength: 0.7 }
                ];
                return principles;
            }

            renderCompleteSummary() {
                const statsContainer = document.getElementById('npi-stats');
                
                if (!this.npiBrain) {
                    statsContainer.innerHTML = '<p>Error generating NPI brain.</p>';
                    return;
                }

                const responses = this.questionnaire.getAnsweredCount();
                const totalQuestions = this.questionnaire.getTotalQuestions();

                statsContainer.innerHTML = `
                    <div class="stat-item">
                        <h3>${this.npiBrain.metadata.name}</h3>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-number">${responses}</div>
                                <div class="stat-label">Questions Answered</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${this.npiBrain.brain_architecture.neural_network.nodes}</div>
                                <div class="stat-label">Neural Nodes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${this.npiBrain.brain_architecture.moral_framework.principles.length}</div>
                                <div class="stat-label">Core Principles</div>
                            </div>
                        </div>
                        <div class="npi-details">
                            <p><strong>Reasoning Style:</strong> ${this.npiBrain.brain_architecture.reasoning_system.default_style.replace(/_/g, ' ')}</p>
                            <p><strong>Base Mood:</strong> ${this.npiBrain.brain_architecture.emotional_system.base_mood.replace(/_/g, ' ')}</p>
                            <p><strong>Progress:</strong> ${responses}/${totalQuestions} questions completed</p>
                            <p><strong>Created:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
            }

            exportNPIBrain() {
                if (!this.npiBrain) {
                    alert('Please complete the questionnaire first.');
                    return;
                }

                const blob = new Blob([JSON.stringify(this.npiBrain, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `my_npi_brain_${Date.now()}.npibrain`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Your NPI brain has been exported!\n\nYou can now import this .npibrain file into the Avatar Creator.');
            }

            showAvatarMessage() {
                alert('üé≠ Avatar Creator - Coming Soon!\n\nYour NPI brain is ready for integration with 3D avatars and MetaHuman characters.');
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // === GLOBAL FUNCTIONS ===
        function testButton() {
            alert('‚úÖ Test successful! The NPI Profiler is working correctly.');
            console.log('‚úÖ Test button clicked - all systems operational');
        }

        window.startQuestionnaire = function() {
            console.log('üåê Starting complete NPI questionnaire...');
            if (!window.app) {
                window.app = new CompleteNPIApp();
            }
            window.app.startQuestionnaire();
        };

        // === INITIALIZATION ===
        console.log('üöÄ NPI Profiler v1.0 - Complete 47-Question Version');
        console.log('üìù Initializing application...');
        window.app = new CompleteNPIApp();
        console.log('üéâ NPI Profiler ready! Click "Begin Creation" to start.');
    </script>
</body>
</html>
